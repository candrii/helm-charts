{{- if .Values.enabled }}
apiVersion: grafana.integreatly.org/v1beta1
kind: Grafana
metadata:
  name: {{ include "grafana-operator-grafana.grafanaName" . }}
  namespace: {{ include "grafana-operator-grafana.namespace" . }}
  labels:
    {{- include "grafana-operator-grafana.labels" . | nindent 4 }}
    {{- with .Values.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  {{- if .Values.version }}
  version: {{ .Values.version | quote }}
  {{- end }}

  {{- if .Values.instanceSelector }}
  instanceSelector:
    {{- toYaml .Values.instanceSelector | nindent 4 }}
  {{- end }}

  {{- if .Values.suspend }}
  suspend: {{ .Values.suspend }}
  {{- end }}

  {{- if .Values.disableDefaultAdminSecret }}
  disableDefaultAdminSecret: {{ .Values.disableDefaultAdminSecret }}
  {{- end }}

  {{- /* Grafana configuration (grafana.ini) */}}
  {{- if .Values.config }}
  config:
    {{- range $section, $values := .Values.config }}
    {{- if $values }}
    {{ $section }}:
      {{- range $key, $value := $values }}
      {{- if $value }}
      {{ $key }}: {{ $value | quote }}
      {{- end }}
      {{- end }}
    {{- end }}
    {{- end }}
  {{- end }}

  {{- /* External Grafana configuration */}}
  {{- if .Values.external.enabled }}
  external:
    url: {{ .Values.external.url | quote }}
    {{- if .Values.external.adminCredentialsSecret }}
    adminCredentialsSecret: {{ .Values.external.adminCredentialsSecret | quote }}
    {{- end }}
  {{- end }}

  {{- /* Deployment configuration */}}
  {{- if not .Values.external.enabled }}
  deployment:
    spec:
      {{- if .Values.deployment.replicas }}
      replicas: {{ .Values.deployment.replicas }}
      {{- end }}
      template:
        {{- if or .Values.deployment.labels .Values.deployment.annotations }}
        metadata:
          {{- with .Values.deployment.labels }}
          labels:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.deployment.annotations }}
          annotations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
        {{- end }}
        spec:
          {{- with .Values.deployment.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.deployment.nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.deployment.tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.deployment.affinity }}
          affinity:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.deployment.extraVolumes }}
          volumes:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          containers:
            - name: grafana
              {{- with .Values.deployment.containerSecurityContext }}
              securityContext:
                {{- toYaml . | nindent 16 }}
              {{- end }}
              {{- with .Values.deployment.resources }}
              resources:
                {{- toYaml . | nindent 16 }}
              {{- end }}
              {{- with .Values.deployment.env }}
              env:
                {{- toYaml . | nindent 16 }}
              {{- end }}
              {{- with .Values.deployment.extraVolumeMounts }}
              volumeMounts:
                {{- toYaml . | nindent 16 }}
              {{- end }}
  {{- end }}

  {{- /* Service configuration */}}
  {{- if not .Values.external.enabled }}
  service:
    spec:
      type: {{ .Values.service.type }}
      ports:
        - name: grafana
          port: {{ .Values.service.port }}
          protocol: TCP
          targetPort: 3000
    {{- with .Values.service.annotations }}
    metadata:
      annotations:
        {{- toYaml . | nindent 8 }}
    {{- end }}
  {{- end }}

  {{- /* Ingress configuration */}}
  {{- if and .Values.ingress.enabled (not .Values.external.enabled) }}
  ingress:
    spec:
      {{- if .Values.ingress.className }}
      ingressClassName: {{ .Values.ingress.className }}
      {{- end }}
      {{- if .Values.ingress.tls }}
      tls:
        - hosts:
            - {{ .Values.ingress.hostname }}
          {{- if .Values.ingress.tlsSecretName }}
          secretName: {{ .Values.ingress.tlsSecretName }}
          {{- else }}
          secretName: {{ include "grafana-operator-grafana.grafanaName" . }}-tls
          {{- end }}
      {{- end }}
      rules:
        - host: {{ .Values.ingress.hostname }}
          http:
            paths:
              - path: {{ .Values.ingress.path }}
                pathType: {{ .Values.ingress.pathType }}
                backend:
                  service:
                    name: {{ include "grafana-operator-grafana.grafanaName" . }}-service
                    port:
                      number: {{ .Values.service.port }}
    {{- with .Values.ingress.annotations }}
    metadata:
      annotations:
        {{- toYaml . | nindent 8 }}
    {{- end }}
  {{- end }}

  {{- /* Persistence configuration */}}
  {{- if and .Values.persistence.enabled (not .Values.external.enabled) }}
  persistentVolumeClaim:
    spec:
      accessModes:
        {{- toYaml .Values.persistence.accessModes | nindent 8 }}
      resources:
        requests:
          storage: {{ .Values.persistence.size }}
      {{- if .Values.persistence.storageClassName }}
      storageClassName: {{ .Values.persistence.storageClassName }}
      {{- end }}
  {{- end }}

  {{- /* Service account configuration */}}
  {{- if and .Values.serviceAccount.create (not .Values.external.enabled) }}
  serviceAccount:
    metadata:
      name: {{ include "grafana-operator-grafana.serviceAccountName" . }}
      {{- with .Values.serviceAccount.annotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
  {{- end }}

  {{- /* Preferences */}}
  {{- if .Values.preferences.homeDashboardUid }}
  preferences:
    homeDashboardUid: {{ .Values.preferences.homeDashboardUid | quote }}
  {{- end }}

  {{- /* Jsonnet configuration */}}
  {{- if .Values.jsonnet }}
  jsonnet:
    {{- toYaml .Values.jsonnet | nindent 4 }}
  {{- end }}
{{- end }}
