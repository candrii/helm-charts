# =============================================================================
# VICTORIA METRICS AUTHENTIK GATEWAY
# Authentik outpost, VMAuth proxy and Gateway HTTPRoute for SSO authentication
# =============================================================================

# Enable/disable entire chart
enabled: true

# Namespace for deployment
namespace: monitoring

# =============================================================================
# VMAUTH - Victoria Metrics Auth Proxy (subchart)
# Official chart: https://victoriametrics.github.io/helm-charts/
# =============================================================================
vmauth:
  enabled: true
  # Route all requests to vmsingle backend
  config:
    unauthorized_user:
      url_prefix:
        - http://vmsingle-monitoring.monitoring.svc:8429
  service:
    servicePort: 8427
  resources:
    requests:
      memory: 64Mi
      cpu: 10m
    limits:
      memory: 128Mi

# =============================================================================
# AUTHENTIK OUTPOST DEPLOYMENT
# Deploy the actual outpost proxy
# =============================================================================
outpostDeployment:
  enabled: true
  name: vm-authentik-outpost
  replicas: 1

  image:
    repository: ghcr.io/goauthentik/proxy
    tag: "2025.10.2"
    pullPolicy: IfNotPresent

  # Authentik connection settings
  authentik:
    # URL to authentik instance
    url: https://authentik.taxrise.lan
    # Secret name containing AUTHENTIK_TOKEN
    tokenSecretName: authentik-outpost-token
    tokenSecretKey: token
    # Insecure connection to authentik
    insecure: false

  # Resource requests and limits
  resources:
    requests:
      memory: 64Mi
      cpu: 10m
    limits:
      memory: 256Mi

  # Service configuration
  service:
    type: ClusterIP
    ports:
      http: 9000
      https: 9443
      metrics: 9300

  # Pod security context
  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000

  # Additional environment variables
  extraEnv: []

  # Node selector
  nodeSelector: {}

  # Tolerations
  tolerations: []

  # Affinity
  affinity: {}

# =============================================================================
# GATEWAY HTTP ROUTE
# Route traffic through the outpost for authentication
# =============================================================================
httpRoute:
  enabled: true
  name: vm-auth-route

  # Parent gateway reference
  parentRefs:
    - name: internal-gateway
      namespace: gateway-system
      sectionName: https

  # Hostnames to match
  hostnames:
    - vm.hub.taxrise.lan

  # Backend service (VMAuth or direct to vmsingle)
  backendService:
    name: vmauth-monitoring
    namespace: monitoring
    port: 8427

  # Forward auth configuration
  forwardAuth:
    enabled: true
    # Auth endpoint path on outpost - varies by proxy type:
    #   nginx:   /outpost.goauthentik.io/auth/nginx
    #   traefik: /outpost.goauthentik.io/auth/traefik
    #   caddy:   /outpost.goauthentik.io/auth/caddy
    #   envoy:   /outpost.goauthentik.io/auth/envoy (includes ext_authz support)
    authPath: /outpost.goauthentik.io/auth/nginx
    # Callback path prefix for auth redirects
    callbackPath: /outpost.goauthentik.io

  # Additional annotations for HTTPRoute
  annotations: {}

  # Additional rules
  rules: []
